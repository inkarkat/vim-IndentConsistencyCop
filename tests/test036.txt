<?xml version="1.0" encoding="UTF-8"?>
<!-- vim: set ft=ant: -->
<!-- Consistent with tabstop. --> 

<project name="ovictex_quality" default="help" basedir=".">

	<!-- Import properties from build.xml -->
	<import file="build.xml" />

	<property name="reports" location="${project.home}/.reports" />
	<property name="checkstyle.dir" location="${DE}/3rd-party/java/CheckStyle/3.5" />
	<property name="checkstyle.configdir" location="${project.home}/data/toolconfig" />
	<property name="emma.lib.dir" location="${DE}/3rd-party/java/EMMA/2.0.4217/lib" />
	<property name="junit" location="${DE}/3rd-party/java/junit/3.8.1/junit.jar" />

	<!-- ========== -->
	<!-- checkstyle -->
	<!-- ========== -->
	<target name="checkstyle" description="Generates a report of code convention violations.">
		<taskdef resource="checkstyletask.properties" classpath="${checkstyle.dir}/checkstyle-all-3.5.jar" />
		<delete dir="${reports}/checkstyle" />
		<mkdir dir="${reports}/checkstyle" />
		<checkstyle config="${checkstyle.configdir}/checkstyle.xml" failOnViolation="false">
			<formatter type="xml" tofile="${reports}/checkstyle/checkstyle_report.xml" />
			<fileset dir="Java/src" includes="**/*.java" excludes="**/ICT_SERVICE_DESK_API*" />
			<fileset dir="${sharedcomponents.home}/Java/src" includes="**/*.java" />
		</checkstyle>
		<style in="${reports}/checkstyle/checkstyle_report.xml" out="${reports}/checkstyle/index.html" style="${checkstyle.configdir}/checkstyle-noframes.xsl" />
	</target>

	<!-- =========== -->
	<!-- JUnit tests -->
	<!-- =========== -->
	<target name="runtest" description="Runs a given JUnit test. syntax:  ant runtest -Dtestname=fully_qualified_classname">
		<delete file="${project.home}/junit.output" />
		<junit fork="yes" printsummary="on">
			<classpath refid="project.classpath" />
			<formatter type="plain" />
			<test name="${testname}" outfile="junit.output"/>
		</junit>
		<antcall target="print.current.time" />
	</target>

	<target name="junit.developer" description="Runs the JUnit tests without building sources before. Has to be done manually.">
		<property name="testname" value="${pkgname}.AllTests" />
		<antcall target="runtest" />
	</target>

	<target name="junit" depends="fresh" description="Runs the JUnit tests.">
		<antcall target="junit.developer" />
	</target>

	<!-- ==== -->
	<!-- Emma -->
	<!-- ==== -->
	<property name="out.lib.dir" location="${main.output.root.dir}/ovictex/WEB-INF/lib" />
	<property name="all.jars" location="${out.lib.dir}/ojdbc14.jar;${out.lib.dir}/msbase.jar;${out.lib.dir}/msutil.jar;${out.lib.dir}/mssqlserver.jar;${out.lib.dir}/web-api.jar;${out.lib.dir}/axis.jar;${out.lib.dir}/jasrpc.jar;${out.lib.dir}/commons-discovery-0.2.jar;${out.lib.dir}/commons-logging-1.0.4.jar;${out.lib.dir}/saaj.jar;${out.lib.dir}/wsdl4f-1.5.1.jar;${out.lib.dir}/jakarta-oro-2.0.8.jar;${out.lib.dir}/commons-net-1.4.0.jar;${DE}/stage.2/java/release/OvXpl/xpl.jar;${DE}/stage.1/java/release/OvSecCore/OvSecCore.jar" />
	<path id="emma.testclasses" >
		<pathelement location="${buildout}" />
		<pathelement location="${project.home}/Java/_ant-testbin" />
	</path>

	<target name="emma" description="Generates a report of unit test coverage. " depends="fresh.debug">
		<taskdef resource="emma_ant.properties" classpath="${emma.lib.dir}/emma.jar;${emma.lib.dir}/emma_ant.jar" />
		<delete dir="${reports}/emma" />
		<mkdir dir="${reports}/emma" />
		<emmajava fullmetadata="yes" sourcepath="${msgout}/src;${sharedcomponents.home}/Java/src;${project.home}/Java/test;${sharedcomponents.home}/Java/test"
			libclasspath="${emma.lib.dir}/emma.jar;${emma.lib.dir}/emma_ant.jar;${junit};${all.jars}"
			classname="com.hp.ov.ictex.AllTests" classpathref="emma.testclasses">
			<!-- FIXME: Remove the duplication of the <emmajava sourcepath="..."> attribute with the <javac><src path="..."> by defining a separate <classpathref> and linking to it via <emmajava sourcepathref="...">. -->
			<txt outfile="${reports}/emma/coverage.txt" />
			<html outfile="${reports}/emma/index.html" />
		</emmajava>
	</target>

</project>
